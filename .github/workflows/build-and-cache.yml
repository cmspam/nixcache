name: "Build and Cache NixOS Systems"

on:
  pull_request:
  push:
  schedule:
    - cron: '0 */8 * * *'  # Every 8 hours - catches upstream input updates

jobs:
  build-zephyrus:
    name: "Build zephyrus (zen4 LTO kernel + BBR modules + NVIDIA)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            # Pull from all known caches before building anything
            substituters = https://cache.nixos.org https://attic.xuyh0120.win/lantian https://jovian-experiments.cachix.org https://cmspam.cachix.org https://lanzaboote.cachix.org https://nix-community.cachix.org https://cuda-maintainers.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= lantian:EeAUQ+W+6r7EtwnmYjeVwx5kOGEBpjlBfPlzGlTNvHc= jovian-experiments.cachix.org-1:TyDJIG9AdB5uEAHVAVCjXU1qKBZkCIvqj4rDRz5/sfY= cmspam.cachix.org-1:Xd8Ff8s65DuMHtLf+kpSsdBB62gokpj5PQWA74NU++s= lanzaboote.cachix.org-1:Nt9//zGmqkg1k5iu+B3bkj3OmHKjSw9pvf3faffLLNk= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= cuda-maintainers.cachix.org-1:0dq3bujKpuEPMCX6U4WylrUDZ9JyUG0VpVZa7CNfq5E=

      - name: Setup Cachix (push target)
        uses: cachix/cachix-action@v14
        with:
          name: cmspam
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Update flake inputs
        run: nix flake update --accept-flake-config

      - name: Build zephyrus system (full closure)
        run: |
          nix build .#zephyrus-system \
            --accept-flake-config \
            --print-build-logs \
            --keep-going \
            --max-jobs 1 \
            --cores 2

  build-gamepc:
    name: "Build gamepc (x86_64-v3 LTO kernel + BBR modules + NVIDIA)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            substituters = https://cache.nixos.org https://attic.xuyh0120.win/lantian https://jovian-experiments.cachix.org https://cmspam.cachix.org https://lanzaboote.cachix.org https://nix-community.cachix.org https://cuda-maintainers.cachix.org
            trusted-public-keys = cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= lantian:EeAUQ+W+6r7EtwnmYjeVwx5kOGEBpjlBfPlzGlTNvHc= jovian-experiments.cachix.org-1:TyDJIG9AdB5uEAHVAVCjXU1qKBZkCIvqj4rDRz5/sfY= cmspam.cachix.org-1:Xd8Ff8s65DuMHtLf+kpSsdBB62gokpj5PQWA74NU++s= lanzaboote.cachix.org-1:Nt9//zGmqkg1k5iu+B3bkj3OmHKjSw9pvf3faffLLNk= nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs= cuda-maintainers.cachix.org-1:0dq3bujKpuEPMCX6U4WylrUDZ9JyUG0VpVZa7CNfq5E=

      - name: Setup Cachix (push target)
        uses: cachix/cachix-action@v14
        with:
          name: cmspam
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Update flake inputs
        run: nix flake update --accept-flake-config

      - name: Build gamepc system (full closure)
        run: |
          nix build .#gamepc-system \
            --accept-flake-config \
            --print-build-logs \
            --keep-going \
            --max-jobs 1 \
            --cores 2
